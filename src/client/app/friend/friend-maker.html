<!-- Header -->
<header id="header" class="container">
    <h1>Bootstrap 3 + Masonry 3</h1>
    <p class="lead">
        This is deployed with the <code>#grid</code> div fluid (that is, it has no Bootstrap <code>.container</code> class). To make it fixed simply add the <code>.container</code> class to it. Use the media queries in <strong>style.css</strong> to change the grid's post widths and margins.
    </p>
    <hr>
</header>


<div id="grid">
    <div id="posts">
        <div class="post" ng-repeat="p in vm.personsData.people">
            <img class="circle" src="/app/img/{{p.img}}" alt="icon">
            <h4 class="list-group-item-heading">{{p.first}} {{p.last}}</h4>
            <p class="list-group-item-text">{{p.blurb}}</p>
        </div>
    </div>
</div>


<script>
    // TODO: Put Masonry into the Bower build
    // Load is used to ensure all images have been loaded, impossible with document
    jQuery(window).load(function () {
        setTimeout(function(){
            // Takes the gutter width from the bottom margin of .post
            var gutter = parseInt(jQuery('.post').css('marginBottom'));
            var container = jQuery('#posts');

            // Creates an instance of Masonry on #posts
            container.masonry({
                gutter: gutter,
                itemSelector: '.post',
                columnWidth: '.post'
            });

            // This code fires every time a user resizes the screen and only affects .post elements
            // whose parent class isn't .container. Triggers resize first so nothing looks weird.
            jQuery(window).bind('resize', function () {
                if (!jQuery('#posts').parent().hasClass('container')) {
                    // Resets all widths to 'auto' to sterilize calculations
                    post_width = jQuery('.post').width() + gutter;
                    jQuery('#posts, body > #grid').css('width', 'auto');
                    // Calculates how many .post elements will actually fit per row. Could this code be cleaner?
                    posts_per_row = jQuery('#posts').innerWidth() / post_width;
                    floor_posts_width = (Math.floor(posts_per_row) * post_width) - gutter;
                    ceil_posts_width = (Math.ceil(posts_per_row) * post_width) - gutter;
                    posts_width = (ceil_posts_width > jQuery('#posts').innerWidth()) ? floor_posts_width : ceil_posts_width;
                    if (posts_width == jQuery('.post').width()) {
                        posts_width = '100%';
                    }
                    // Ensures that all top-level elements have equal width and stay centered
                    jQuery('#posts, #grid').css('width', posts_width);
                    jQuery('#grid').css({'margin': '0 auto'});
                }

            }).trigger('resize');
        },400);
    });
</script>